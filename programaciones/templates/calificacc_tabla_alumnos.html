{% extends "base_select2-4.html" %}
{% load my_templatetags %}

{% block contenido %}
    <style>
        .title_page {
            text-align: center;
            color: #008CBA;
        }

        .tabla_cc {
            white-space: nowrap;
            table-layout: fixed;
            width: 100%;
            overflow-x: auto;
            display: block;
        }


        .tex_cal {
            color: green;
            font-weight: bold;
        }


        .pagebreak {
            page-break-before: always;
        }

        .no_visible {
            display: none;
        }
    </style>
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}
        {% for alumno in alumnos %}
            <div id="tabla_generar_informe{{ alumno.id }}">
                <p style="font-weight: bold;font-size: large;">
                    Alumno: <span class="nombre_alumno_informe_cc">{{ alumno.gauser.get_full_name }}</span>
                </p>
                <p style="font-weight: bold;"
                   id="nombre_centro_alumno{{ alumno.id }}">{{ alumno.ronda.entidad.name }}</p>
                <p>
                    Curso: <span style="font-weight: bold;"
                                 class="nombre_curso_informe_cc">{% for curso in alumno.gauser_extra_estudios.grupo.cursos.all %}
                    {{ curso.nombre }}{% endfor %}</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    Grupo: <span style="font-weight: bold;"
                                 class="nombre_grupo_informe_cc">{{ alumno.gauser_extra_estudios.grupo.nombre }}</span>
                </p>
                <table style="width: 100%;">
                    <thead>
                    <tr>
                        <th colspan="2" style="text-align: center;">Grado de adquisición de las competencias clave</th>
                    </tr>
                    <tr>
                        <th>Competencia Clave</th>
                        <th style="text-align: center;">Calificación</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for cc in ps.competenciaclave_set.all %}
                        <tr>
                            <td>
                                {{ cc.competencia }}
                            </td>
                            <td id="cal_cc_informe{{ cc.siglas }}_{{ alumno.id }}"
                                style="font-weight: bold;text-align: center;" contenteditable="true"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <p>La notación sobre el grado de adquisición de las competencias clave se ha realizado utilizando la
                    nomenclatura A,
                    B, C, D con el siguiente significado:</p>
                <p>
                    A: Ha alcanzado en grado alto, de forma destacada, la adquisición de la competencia.
                </p>
                <p>
                    B: Ha alcanzado un nivel suficiente, en grado medio,de adquisición de la competencia.
                </p>
                <p>
                    C: Ha logrado, en grado bajo, o está en proceso de alcanzar la competencia correspondiente.
                </p>
                <p>
                    D: No ha alcanzado el grado esperado de la competencia.
                </p>

                <p style="font-weight: bold;font-size: large;" class="pagebreak no_visible">
                    Alumno: <span class="nombre_alumno_informe_cc">{{ alumno.gauser.get_full_name }}</span>
                </p>
                <p class="no_visible">
                    Curso: <span style="font-weight: bold;"
                                 class="nombre_curso_informe_cc">{% for curso in alumno.gauser_extra_estudios.grupo.cursos.all %}
                    {{ curso.nombre }}{% endfor %}</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    Grupo: <span style="font-weight: bold;"
                                 class="nombre_grupo_informe_cc">{{ alumno.gauser_extra_estudios.grupo.nombre }}</span>
                </p>
                <table style="width: 100%;">
                    <thead>
                    <tr>
                        <th colspan="3" style="text-align: center;">Perfil de salida (evaluación de los descriptores
                            operativos)
                        </th>
                    </tr>
                    <tr>
                        <th style="text-align: center;">Competencia Clave</th>
                        <th style="text-align: center;">Descriptores Operativos</th>
                        <th style="text-align: center;">Calificación</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for cc in ps.competenciaclave_set.all %}
                        {% for do in cc.descriptoroperativo_set.all %}
                            <tr>
                                {% if forloop.first %}
                                    <td rowspan="{{ cc.descriptoroperativo_set.all|length }}">
                                        {{ cc.competencia }}
                                    </td>
                                {% endif %}
                                <td title="{{ do.clave }}">
                                    {{ do.texto }}
                                </td>
                                <td id="cal_do_informe{{ do.clave }}_{{ alumno.id }}" style="text-align: center;"
                                    contenteditable="true"></td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                    </tbody>
                </table>

                <p style="font-weight: bold;font-size: large;" class="pagebreak no_visible">
                    Alumno: <span class="nombre_alumno_informe_cc">{{ alumno.gauser.get_full_name }}</span>
                </p>
                <p class="no_visible">
                    Curso: <span style="font-weight: bold;"
                                 class="nombre_curso_informe_cc">{% for curso in alumno.gauser_extra_estudios.grupo.cursos.all %}
                    {{ curso.nombre }}{% endfor %}</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    Grupo: <span style="font-weight: bold;"
                                 class="nombre_grupo_informe_cc">{{ alumno.gauser_extra_estudios.grupo.nombre }}</span>
                </p>
                <table style="width: 100%;">
                    <thead>
                    <tr>
                        <th colspan="3" style="text-align: center;">
                            Evaluación de las competencias específicas vinculadas a cada asignatura
                        </th>
                    </tr>
                    <tr>
                        <th style="text-align: center;">Asignatura</th>
                        <th style="text-align: center;">Competencia Específica</th>
                        <th style="text-align: center;">Calificación</th>
                    </tr>
                    </thead>
                    {% for am in ams %}
                        <tbody class="tbody_am" id="tbody_am{{ am.id }}_{{ alumno.id }}">
                        {% for ce in am.competenciaespecifica_set.all %}
                            <tr>
                                {% if forloop.first %}
                                    <td rowspan="{{ am.competenciaespecifica_set.all|length }}">
                                        {{ am.nombre }}
                                    </td>
                                {% endif %}
                                <td title="CE{{ ce.orden }}">
                                    {{ ce.nombre }}
                                </td>
                                <td id="cal_ce_informe{{ ce.id }}_{{ alumno.id }}" style="text-align: center;"
                                    contenteditable="true"></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    {% endfor %}
                </table>
            </div>
            <span class="pagebreak"></span>
        {% endfor %}
    </form>

{% endblock %}

{% block final %}
    <script type="text/javascript">
        {#$('#boton_informe_cc_pdf').show();#}

        function carga_alumnocc(alumno) {
            $.post('/calificacc_all/{{ grupo_id }}/', {'action': 'carga_alumnocc', alumno_id: alumno},
                function (data) {
                    if (data.ok) {
                        $.each(data.cal_ces, function (id, value) {
                            if (value === 0) {
                                $('#' + id).html('-');
                            } else {
                                $('#' + id).html(value.toFixed(2));
                            }
                        });
                        $.each(data.cal_dos, function (id, value) {
                            $('#' + id).html(value.toFixed(2));
                        });
                        $.each(data.cal_ccs, function (id, value) {
                            if (value <= 4) {
                                calificacion_CC = 'D';
                            } else if (value <= 6) {
                                calificacion_CC = 'C';
                            } else if (value <= 8) {
                                calificacion_CC = 'B';
                            } else {
                                calificacion_CC = 'A';
                            }
                            $('#' + id).html(calificacion_CC);
                        });
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        show_mensajes({title: '<i class="fa fa-warning"></i> Error', texto: data.msg})
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                }
            )
        }


        var alumnos_id = JSON.parse('{{ alumnos_id | escapejs }}');
        setTimeout(function () {
            alumnos_id.forEach(function (alumno_id) {
                carga_alumnocc(alumno_id);
            });
        }, 200);


        function carga_alumnocc_antigua(alumno) {
            $.post('/calificacc_all/{{ grupo_id }}/', {'action': 'carga_alumnocc', alumno_id: alumno},
                function (data) {
                    if (data.ok) {
                        {# Instrucciones para rellenar tabla que genera el informe de CC: #}
                        {#$('.nombre_alumno_informe_cc').html(data.nombre_alumno);#}
                        {#                        #}
                        {#                        $('.nombre_grupo_informe_cc').html(data.grupo);#}
                        {#                        $('.nombre_curso_informe_cc').html(data.cursos.toString());#}
                        {# Fin de las instrucciones #}


                        {# Mostrar alerta en caso de cuadernos múltiples para la misma asignatura #}
                        {#if (data.msg_ams_multiples) {#}
                        {#    $('#info_cuadernos_multiples_lis').html(data.msg_ams_multiples);#}
                        {#    $('#info_cuadernos_multiples').show();#}
                        {# } else {#}
                        {#    $('#info_cuadernos_multiples').hide();#}
                        {# }#}
                        {# Fin mostrar alerta #}


                        {#var el = $('#nombre_alumno');#}
                        {#el.html(data.nombre_alumno);#}
                        {#$('#info_cuadernos_alumno').html(data.html);#}
                        {#var left_fixed = el.width();#}
                        {#$('.fixed_column2').css('right', left_fixed);#}
                        $.each(data.cal_dos, function (id, value) {
                            $('#' + id + '_' + data.alumno_id).html(value);
                        });

                        {# Instrucciones para rellenar tabla que genera el informe de CC: #}
                        $.each(data.cal_ces, function (id, value) {
                            if (value === 0) {
                                $('#' + id + '_' + data.alumno_id).html('-');
                            } else {
                                $('#' + id + '_' + data.alumno_id).html(value);
                            }
                        });
                        {#$('.tbody_am').hide();#}
                        {#setTimeout(function () {#}
                        {#    for (var idx in data.ams) {#}
                        {#        $('#tbody_am' + data.ams[idx] + '_' + data.alumno_id).show();#}
                        {#    }#}
                        {# }, 200);#}
                        {# Fin de las instrucciones #}

                        setTimeout(function () {
                            for (var idx in data.dos_claves) {
                                var clave = data.dos_claves[idx];
                                var cal_do = 0;
                                var num_cal_do = 0;
                                $.each($('.' + clave), function (id, element) {
                                    var cal = parseFloat($(element).html());
                                    if (cal > 0) {
                                        num_cal_do += 1;
                                        cal_do += cal;
                                    }
                                    if (num_cal_do === 0) {
                                        $('#' + clave + '_' + data.alumno_id).html('-');
                                    } else {
                                        $('#' + clave + '_' + data.alumno_id).html((cal_do / num_cal_do).toFixed(2));
                                    }

                                    {# Instrucciones para rellenar tabla que genera el informe de CC: #}
                                    if (num_cal_do === 0) {
                                        $('#cal_do' + clave + '_' + data.alumno_id).html('-');
                                    } else {
                                        $('#cal_do' + clave + '_' + data.alumno_id).html((cal_do / num_cal_do).toFixed(2));
                                    }
                                    {# Fin de las instrucciones #}
                                });
                            }
                        }, 400);
                        setTimeout(function () {
                            for (var idx in data.cc_siglas) {
                                var clave = data.cc_siglas[idx];
                                var cal_cc = 0;
                                var num_cal_cc = 0;
                                $.each($('.' + clave), function (id, element) {
                                    var cal = parseFloat($(element).html());
                                    if (cal > 0) {
                                        num_cal_cc += 1;
                                        cal_cc += cal;
                                    }
                                    if (num_cal_cc === 0) {
                                        $('#' + clave + '_' + data.alumno_id).html('-');
                                    } else {
                                        $('#' + clave + '_' + data.alumno_id).html((cal_cc / num_cal_cc).toFixed(2));
                                    }
                                    {# Instrucciones para rellenar tabla que genera el informe de CC: #}
                                    if (num_cal_cc === 0) {
                                        $('#cal_' + clave + '_' + data.alumno_id).html('D');
                                    } else {
                                        var calificacion = (cal_cc / num_cal_cc);
                                        var calificacion_CC = 'D';
                                        if (calificacion <= 4) {
                                            calificacion_CC = 'D';
                                        } else if (calificacion <= 6) {
                                            calificacion_CC = 'C';
                                        } else if (calificacion <= 8) {
                                            calificacion_CC = 'B';
                                        } else {
                                            calificacion_CC = 'A';
                                        }
                                        $('#cal_' + clave + '_' + data.alumno_id).html(calificacion_CC);
                                    }
                                    {# Fin de las instrucciones #}
                                });
                            }
                        }, 600);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        show_mensajes({title: '<i class="fa fa-warning"></i> Error', texto: data.msg})
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                }
            )
        }
    </script>
{% endblock %}