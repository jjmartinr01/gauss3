{% extends "base_select2-4.html" %}
{% load my_templatetags %}

{% block contenido %}
    <style>
        .title_page {
            text-align: center;
            color: #008CBA;
        }

        .ckeditor {
            border: lightgrey 1px solid;
            min-height: 100px;
        }
    </style>
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}
        <input type="hidden" id="id_cuaderno" name="id_cuaderno" value="{{ sb.id }}">
        <div>
            <h4 class="title_page"><strong>Cuadernos de docente asociados a programaciones didácticas</strong></h4>
        </div>
        <div id="contenido_cuadernos">
            <br>
            <dl class="accordion" data-accordion id="list_cuadernos">
                {% for cuaderno in g_e.cuadernoprof_set.all %}
                    {% include 'cuadernoprofesor_accordion.html' %}
                {% endfor %}
            </dl>
        </div>
    </form>
{% endblock %}

{% block final %}
    <script>
        {% comment %}
        config = {
            removePlugins: 'exportpdf',
            toolbar: [
                {name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo']},
                {name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll', '-', 'Scayt']},
                {
                    name: 'basicstyles',
                    items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'CopyFormatting', 'RemoveFormat']
                },
                {
                    name: 'paragraph',
                    items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock']
                },
                '/',
                {name: 'links', items: ['Link', 'Unlink', 'Anchor']},
                {name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak']},
                {name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize']},
                {name: 'colors', items: ['TextColor', 'BGColor']},
                {name: 'tools', items: ['Maximize', 'ShowBlocks']},
                {name: 'document', items: ['Source']},
                {name: 'about', items: ['About', 'generapdfbutton']}
            ],
            extraAllowedContent: 'span[id];b;h2;h3;table;tr;td[id];',
        }

        habilita(['s_search']);
        {% endcomment %}
        {% if g_e|has_permiso:"crea_programaciones" %}
            habilita(['s_plus']);
            $('#plus_sign').click(function (event) {
                event.preventDefault();
                $.post(/cuadernoprofesor/, {'action': 'crea_cuaderno'},
                    function (data) {
                        if (data.ok) {
                            $('#list_cuadernos').append(data.html);
                            $("#update_ok").show().delay(1500).fadeOut();
                        } else {
                            show_mensajes({title: '<i class="fa fa-warning"></i> Error', texto: data.msg})
                            $("#update_error").show().delay(1500).fadeOut();
                        }
                        {#$(document).scrollTop($('#title_page').offset().top - 150);#}
                    });
            });
        {% endif %}

        $(document).foundation({
            accordion: {
                callback: function (accordion) {
                    if (accordion.hasClass('accordion-cuaderno')) {
                        var id = accordion.data('id');
                        if ($('#circle' + id).hasClass('fa-plus-circle')) {
                            $('.circle_icon').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                            $('#circle' + id).removeClass('fa-plus-circle').addClass('fa-minus-circle');
                            window.scrollTo(0, $('#accordion' + id).offset().top - 50);
                            $.post(/cuadernoprofesor/, {action: 'open_accordion', id: id},
                                function (data) {
                                    if (data.ok) {
                                        $('#panel' + id).html(data.html);
                                        {#destroyEditorInstances();#}
                                        {#constructInlineEditorInstances(id);#}
                                        $('#id_cuaderno').val(id);
                                        {# utilizado para generar pdf #}
                                        $("#update_ok").show().delay(1500).fadeOut();
                                    } else {
                                        $("#update_error").show().delay(1500).fadeOut();
                                    }
                                });
                        } else {
                            $('#circle' + id).removeClass('fa-minus-circle').addClass('fa-plus-circle');
                            $('#panel' + id).html('');
                        }
                    }
                }
            }
        });

        $('body').on('change', '.select_psec', function () {
            var element = $(this);
            var cuaderno = element.data('cuaderno');
            var psec = element.val();
            $.post(/cuadernoprofesor/, {
                    action: 'select_psec', psec: psec
                },
                function (data) {
                    if (data.ok) {
                        $('#select_grupo' + cuaderno).prop('disabled', false).html(data.html);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        });

        $('#Contenido').on('click', '.configura_cuaderno', function (e) {
            e.preventDefault();
            var element = $(this);
            var cuaderno = element.data('cuaderno');
            var psec = $('#select_psec' + cuaderno).val();
            var grupo = $('#select_grupo' + cuaderno).val();
            $.post(/cuadernoprofesor/, {
                    action: 'configura_cuaderno', cuaderno: cuaderno, psec: psec, grupo: grupo
                },
                function (data) {
                    if (data.ok) {
                        $('#panel' + cuaderno).html(data.html);
                        $('#nombre' + cuaderno).html(data.nombre);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        });

        $('#Contenido').on('mouseenter', '.create_calalumn', function (e) {
            e.preventDefault();
            var element = $(this);
            var cuaderno = element.data('cuaderno');
            var cieval = element.data('cieval');
            var ge = element.data('ge');
            $.post(/cuadernoprofesor/, {
                    action: 'create_calalumn', cuaderno: cuaderno, cieval: cieval, ge: ge
                },
                function (data) {
                    if (data.ok) {
                        element.removeClass('create_calalumn').addClass('update_calalumn');
                        element.html(data.cal);
                        element.prop('contenteditable', 'true');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        });
        {% comment %}
        function get_texto_from_element(element) {
            if (element.val()) {
                return element.val();
            } else {
                return element.html();
            }
        }

        $('body').on('keyup', '.update_texto', function () {
            var element = $(this);
            var id = element.data('id');
            var campo = element.data('campo');
            var clase = element.data('clase');
            var antiguo_texto = get_texto_from_element(element);
            setTimeout(function () {
                var nuevo_texto = get_texto_from_element(element);
                if (antiguo_texto === nuevo_texto) {
                    $.post(/cuadernoprofesor/, {
                            action: 'update_texto', id: id, texto: nuevo_texto, campo: campo,
                            clase: clase
                        },
                        function (data) {
                            if (data.ok) {
                                if (campo === 'nombre') {
                                    $('#nombre' + id).html(nuevo_texto);
                                }
                                $("#update_ok").show().delay(1500).fadeOut();
                            } else {
                                $('#update_error').show().delay(1500).fadeOut();
                            }
                        });
                }
            }, 750);
        });

        $('body').on('change', '.update_many2many', function () {
            var element = $(this);
            var id = element.data('id');
            var idm2m = element.data('idm2m');
            var campo = element.data('campo');
            var clase = element.data('clase');
            var clasem2m = element.data('clasem2m');
            var checked = element.prop('checked');
            $.post(/cuadernoprofesor/, {
                    action: 'update_many2many', id: id, checked: checked, campo: campo, clase: clase,
                    clasem2m: clasem2m, idm2m: idm2m
                },
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        });





        $('body').on('click', '.borrar_cuaderno_actividad', function () {
            id = $(this).data('id');
            show_mensajes({
                title: '<i class="fa fa-warning"></i> ¿Borrar este actividad?',
                texto: 'Si aceptas la actividad se borrará por completo de la base de datos.',
                size: 'large',
                buttons: {
                    "Cancelar": function () {
                        hide_mensajes();
                    },
                    "Borrar": function () {
                        hide_mensajes();
                        $.post(/cuadernoprofesor/, {action: 'borrar_cuaderno_actividad', id: id},
                            function (data) {
                                if (data.ok) {
                                    $('#contenido_actividad' + id).remove();
                                    $("#update_ok").show().delay(1500).fadeOut();
                                } else {
                                    $('#update_error').show().delay(1500).fadeOut();
                                }
                            });
                    }
                }
            });
        });

        $('#Contenido').on('click', '.add_act_instrumento', function (e) {
            e.preventDefault();
            var element = $(this);
            var act = element.data('act');
            $.post(/cuadernoprofesor/, {
                    action: 'add_act_instrumento', act: act
                },
                function (data) {
                    if (data.ok) {
                        $('#list_instrumentos_actividad' + act).append(data.html);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '.borrar_act_instrumento', function () {
            id = $(this).data('id');
            show_mensajes({
                title: '<i class="fa fa-warning"></i> ¿Borrar este procedimiento de evaluación?',
                texto: 'Si aceptas el procedimiento se borrará por completo de la base de datos.',
                size: 'large',
                buttons: {
                    "Cancelar": function () {
                        hide_mensajes();
                    },
                    "Borrar": function () {
                        hide_mensajes();
                        $.post(/cuadernoprofesor/, {action: 'borrar_act_instrumento', id: id},
                            function (data) {
                                if (data.ok) {
                                    $('#cuaderno_act_intrumento' + id).remove();
                                    $("#update_ok").show().delay(1500).fadeOut();
                                } else {
                                    $('#update_error').show().delay(1500).fadeOut();
                                }
                            });
                    }
                }
            });
        });

        function refresh_table_criteval(element) {
            var id = element.data('id');
            $.post(/cuadernoprofesor/, {
                    action: 'table_criteval', id: id
                },
                function (data) {
                    if (data.ok) {
                        $('#table_criteval' + id).html(data.html);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                });
        }

        $('#Contenido').on('mouseenter', '.table_criteval', function () {
            var element = $(this);
            refresh_table_criteval(element);
        });
        $('#Contenido').on('click', '.refresh_table_criteval', function (e) {
            e.preventDefault();
            var element = $(this);
            refresh_table_criteval(element);
        });
        {% endcomment %}

    </script>

{% endblock %}
